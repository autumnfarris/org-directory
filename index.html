<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NMFS OCIO Directory</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'nmfs-blue': '#003185',
                        'nmfs-light-blue': '#0085ca'
                    }
                }
            }
        }
    </script>

    <style>
        body {
            font-family: Arial, Helvetica, sans-serif;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #003185;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            0% { opacity: 0; transform: translateY(20px); }
            100% { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-white min-h-screen flex flex-col">

    <!-- Loading Screen -->
    <div id="loading-screen" class="min-h-screen flex items-center justify-center bg-gray-50">
        <div class="text-center">
            <div class="loading-spinner mx-auto mb-4"></div>
            <div class="text-lg text-nmfs-blue">Loading NMFS OCIO Organization Data...</div>
        </div>
    </div>

    <!-- Error Screen -->
    <div id="error-screen" class="min-h-screen flex items-center justify-center bg-gray-50 hidden">
        <div class="text-center p-6 bg-white rounded-lg shadow-lg">
            <div class="text-red-600 text-lg font-semibold mb-2">Error Loading Data</div>
            <div id="error-message" class="text-gray-600"></div>
            <button onclick="location.reload()" class="mt-4 px-4 py-2 bg-nmfs-blue text-white rounded hover:bg-blue-800">
                Retry
            </button>
        </div>
    </div>

    <!-- Main Application -->
    <div id="main-app" class="hidden min-h-screen flex flex-col">
        <!-- Header -->
        <div class="bg-nmfs-blue text-white">
            <div class="max-w-6xl mx-auto px-6 py-8">
                <h1 class="text-3xl font-bold text-center">
                    NMFS Office of the Chief Information Officer
                </h1>
                <p class="text-center text-blue-100 mt-2">Organization Directory</p>
            </div>
        </div>

        <div class="flex-1 max-w-4xl mx-auto px-6 py-8 w-full">
            <!-- CIO Section -->
            <div id="cio-section" class="mb-8 flex flex-col items-center">
                <div class="text-sm font-medium text-gray-600 mb-2 text-center">Chief Information Officer</div>
                <div id="cio-name" class="text-xl font-semibold text-gray-900 mb-4 text-center">Chief Information Officer Name</div>
                <div class="border-b border-gray-200 w-full"></div>
            </div>

            <!-- Deputy CIO Section -->
            <div id="deputy-cio-section" class="mb-8 flex flex-col items-center">
                <div id="deputy-cio-container" class="flex flex-wrap justify-center gap-10 text-lg font-semibold text-gray-900 mb-4">
                    <span id="deputy-cio-name">Deputy CIO Name</span>
                </div>
                <div class="border-b border-gray-200 w-full"></div>
            </div>

            <!-- Divisions Section -->
            <div id="divisions-section" class="hidden">
                <!-- Division Tabs -->
                <div id="division-tabs" class="flex flex-wrap gap-2 mb-8 justify-center"></div>

                <!-- Active Division Content -->
                <div id="division-content" class="hidden"></div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="bg-nmfs-blue text-white text-center py-4 w-full mt-auto">
            <p class="text-sm">
                NOAA | NMFS Office of the Chief Information Officer
            </p>
        </footer>
    </div>

    <script>
        // Global state
        let orgData = null;
        let activeDivision = null;
        let activeDivisions = []; // For multiple divisions when deputy is clicked
        let activeDeputy = null; // Track which deputy is selected

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
        });

        // Load organization data
        function showError(message) {
            hideLoading();
            document.getElementById('error-message').textContent = message;
            document.getElementById('error-screen').classList.remove('hidden');
            document.getElementById('main-app').classList.add('hidden');
        }

        function hideLoading() {
            document.getElementById('loading-screen').classList.add('hidden');
        }

        async function loadData() {
            try {
                const employees = await fetchEmployeeData();
                const organizedData = organizeEmployeeData(employees);
                console.log("Organized data:", organizedData);

                const filteredDivisions = organizedData?.divisions?.filter(
                    div => !['CIO', 'DDCIO1', 'DDCIO2'].includes(div.name?.toUpperCase())
                ) || [];

                orgData = {
                    cio: organizedData.cio,
                    deputyCIO: organizedData.deputyCIO,
                    divisions: filteredDivisions
                };
                hideLoading();
                document.getElementById('main-app').classList.remove('hidden');
                renderApplication();

                if (filteredDivisions.length > 0) {
                    activeDivision = 0;
                    activeDivisions = []; // Reset multiple divisions when data loads
                    activeDeputy = null; // Reset active deputy when data loads
                    renderDivisionContent();
                }
            } catch (err) {
                showError(err.message);
            }
        }

        // Fetch employee data with environment detection
        async function fetchEmployeeData() {
            try {
                // Environment detection
                const isGAS = typeof google !== 'undefined' && google.script;
                const isLocalDev = typeof process !== 'undefined' && process.env && process.env.NODE_ENV === 'development';

                if (isGAS) {
                    // Running in Google Apps Script environment
                    console.log('Fetching data from Google Apps Script backend...');
                    return new Promise((resolve, reject) => {
                        google.script.run
                            .withSuccessHandler(function(employees) {
                                console.log(`Successfully loaded ${employees?.length || 0} employees from GAS backend`);
                                if (!employees || !Array.isArray(employees) || employees.length === 0) {
                                    console.warn('No employee data received from GAS, using fallback data');
                                    resolve(getFallbackData());
                                } else {
                                    resolve(employees);
                                }
                            })
                            .withFailureHandler(function(error) {
                                console.error('Error fetching employee data from GAS:', error);
                                console.warn('Falling back to local data');
                                resolve(getFallbackData());
                            })
                            .getEmployeeData();
                    });
                } else {
                    // Running in Next.js environment (local dev or production)
                    console.log('Fetching data from Next.js API...');
                    console.log('Environment: ', {
                        isLocalDev,
                        isGAS: false
                    });

                    const response = await fetch('/api/employees', {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    console.log("response: ", response);

                    const employees = await response.json();

                    if (!employees || !Array.isArray(employees) || employees.length === 0) {
                        console.warn('No employee data received from API, using fallback data');
                        return getFallbackData();
                    }

                    console.log(`Successfully loaded ${employees.length} employees from Next.js API`);
                    return employees;
                }
            } catch (error) {
                console.error('Error fetching employee data:', error);
                console.warn('Falling back to local data');
                return getFallbackData();
            }
        }

        // Fallback data function (placeholder)
        function getFallbackData() {
            // In a real implementation, this would return the fallback data
            // For now, return an empty array
            console.warn('Using empty fallback data');
            return [];
        }

        // Organize employee data (client-side processing)
        function organizeEmployeeData(employees) {
                                const cio = employees.find(emp =>
                                                emp.title && emp.title.toLowerCase().includes('chief information officer') &&
                                                !emp.title.toLowerCase().includes('deputy')
                                );

                                const deputyCIO = employees.filter(emp =>
                                                emp.title && emp.title.toLowerCase().includes('deputy cio')
                                );

                                deputyCIO.forEach(emp => {
                                                const associatedDivisions = employees
                                                                .filter(e => e.manager && emp.firstName && emp.lastName && e.manager.toLowerCase().includes(`${emp.firstName.toLowerCase()} ${emp.lastName.toLowerCase()}`))
                                                                .map(e => {
                                                                                if (e.division && e.division.startsWith('CIO/')) {
                                                                                                const parts = e.division.split('/');
                                                                                                return parts.length >= 2 ? parts[1].replace(/\s+$/, '') : 'CIO';
                                                                                }
                                                                                return e.division;
                                                                })
                                                                .filter((value, index, self) => value && self.indexOf(value) === index); // unique values
                                                emp.divisionsOwned = associatedDivisions;
                                });

                                const divisions = {};

                                employees.forEach(employee => {
                                                if (employee.division && employee.division.trim()) {
                                                                let divisionName = employee.division.trim();

                                                                // Extract value after CIO/ and before the second /
                                                                if (divisionName.startsWith('CIO/')) {
                                                                                const parts = divisionName.split('/');
                                                                                if (parts.length >= 2) {
                                                                                                divisionName = parts[1].replace(/\s+$/, '');
                                                                                } else {
                                                                                                divisionName = 'CIO';
                                                                                }
                                                                }

                                                                if (!divisions[divisionName]) {
                                                                                divisions[divisionName] = {
                                                                                                name: divisionName,
                                                                                                directors: [],
                                                                                                programs: {},
                                                                                                employees: []
                                                                                };
                                                                }

                                                                // Check if employee is a director
                                                                if (employee.title && employee.title.toLowerCase().includes('director')) {
                                                                                divisions[divisionName].directors.push(employee);
                                                                                return; // Don't add directors to regular employee lists
                                                                }

                                                                // If employee has a program, organize by program
                                                                if (employee.program && employee.program.trim()) {
                                                                                const programName = employee.program.trim();

                                                                                if (!divisions[divisionName].programs[programName]) {
                                                                                                divisions[divisionName].programs[programName] = {
                                                                                                                name: programName,
                                                                                                                employees: []
                                                                                                };
                                                                                }

                                                                                divisions[divisionName].programs[programName].employees.push(employee);
                                                                } else {
                                                                                // Employee belongs directly to division (no program)
                                                                                divisions[divisionName].employees.push(employee);
                                                                }
                                                }
                                });

                                // Sort employees within each program and division (managers first)
                                Object.values(divisions).forEach(division => {
                                                division.employees.sort((a, b) => {
                                                                const aIsManager = isManager(a);
                                                                const bIsManager = isManager(b);
                                                                if (aIsManager && !bIsManager) return -1;
                                                                if (!aIsManager && bIsManager) return 1;
                                                                return `${a.lastName}, ${a.firstName}`.localeCompare(`${b.lastName}, ${b.firstName}`);
                                                });

                                                Object.values(division.programs).forEach(program => {
                                                                program.employees.sort((a, b) => {
                                                                                const aIsManager = isManager(a);
                                                                                const bIsManager = isManager(b);
                                                                                if (aIsManager && !bIsManager) return -1;
                                                                                if (!aIsManager && bIsManager) return 1;
                                                                                return `${a.lastName}, ${a.firstName}`.localeCompare(`${b.lastName}, ${b.firstName}`);
                                                                });
                                                });
                                });

                                console.log("employees:", employees);

                                return {
                                                cio,
                                                deputyCIO,
                                                divisions: Object.values(divisions)
                                };
                };

        function getEmploymentStatus(employee) {
                const federalCodes = ['GS', 'FED', 'FEDERAL'];
                const status = employee.empl_code || '';
                return federalCodes.some(code => status.toUpperCase().includes(code)) ? 'federal' : 'contractor';
        }

        function isManager(employee) {
            return employee.title && (
                employee.title.toLowerCase().includes('director') ||
                employee.title.toLowerCase().includes('manager') ||
                employee.title.toLowerCase().includes('lead') ||
                employee.title.toLowerCase().includes('chief') ||
                employee.title.toLowerCase().includes('deputy')
            );
        }

        function renderApplication() {
            // Render CIO section
            const cioNameElement = document.getElementById('cio-name');
            if (orgData?.cio) {
                cioNameElement.textContent = `${orgData.cio.firstName} ${orgData.cio.lastName}`;
            } else {
                cioNameElement.textContent = 'Chief Information Officer Name';
            }

            // Render Deputy CIO section with clickable functionality
            const deputyCioContainer = document.getElementById('deputy-cio-container');
            if (orgData?.deputyCIO && orgData.deputyCIO.length > 0) {
                deputyCioContainer.innerHTML = orgData.deputyCIO.map((dep, idx) => {
                    // Find the division index for this deputy
                    const divisionIndex = orgData.divisions.findIndex(
                        div => div.name?.toLowerCase() === dep.division?.trim().toLowerCase()
                    );

                    return `
                        <button
                            type="button"
                            class="hover:underline focus:outline-none px-2 py-1 rounded ${
                                activeDeputy === idx ? 'bg-nmfs-blue text-white' : 'bg-transparent text-gray-900'
                            } ${dep.divisionsOwned?.some(owned => owned?.toLowerCase() === orgData.divisions[activeDivision]?.name?.toLowerCase()) ? 'border border-nmfs-blue bg-blue-50 text-nmfs-blue' : ''}"
                            onclick="handleDeputyClick(${idx})"
                        >
                            ${dep.firstName} ${dep.lastName}
                        </button>
                    `;
                }).join('');
            } else {
                deputyCioContainer.innerHTML = '<span>Deputy CIO Name</span>';
            }

            // Render Divisions section
            if (orgData?.divisions) {
                document.getElementById('divisions-section').classList.remove('hidden');
                renderDivisionTabs();
                renderDivisionContent();
            }
        }

        function renderDivisionTabs() {
            const tabsContainer = document.getElementById('division-tabs');
            tabsContainer.innerHTML = orgData.divisions.map((division, index) =>
                `<button
                    onclick="setActiveDivision(${index})"
                    class="px-4 py-2 text-sm font-medium rounded ${
                        activeDivision === index || activeDivisions.includes(index)
                            ? 'bg-nmfs-blue text-white'
                            : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                    }"
                >
                    ${division.name}
                </button>`
            ).join('');
        }

        function renderDivisionContent() {
            const contentContainer = document.getElementById('division-content');

            // Handle multiple divisions (when deputy CIO is clicked)
            if (activeDivisions.length > 0) {
                let content = '<div class="space-y-8">';

                activeDivisions.forEach((divisionIndex) => {
                    const division = orgData.divisions[divisionIndex];
                    if (!division) return;

                    content += `
                        <div class="border-b border-gray-200 last:border-b-0 pb-6 last:pb-0">
                            ${renderSingleDivision(division)}
                        </div>`;
                });

                content += '</div>';
                contentContainer.innerHTML = content;
                contentContainer.classList.remove('hidden');
                return;
            }

            // Handle single division
            if (activeDivision === null || !orgData.divisions[activeDivision]) return;

            const division = orgData.divisions[activeDivision];
            contentContainer.innerHTML = renderSingleDivision(division);
            contentContainer.classList.remove('hidden');
        }

        function renderSingleDivision(division) {
            let content = `
                <div>
                    <!-- Division Title -->
                    <h2 class="text-xl font-bold text-gray-900 mb-6">
                        ${division.name}
                    </h2>`;

            // Division Directors
            if (division.directors && division.directors.length > 0) {
                content += `
                    <div class="mb-6">
                        ${division.directors.map(director => {
                            return `
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="font-medium text-gray-900">
                                        ${director.firstName} ${director.lastName}
                                    </span>
                                    <span class="px-2 py-1 text-xs bg-gray-100 text-gray-600 rounded">
                                        Director
                                    </span>
                                </div>`;
                        }).join('')}
                        <div class="border-b border-gray-200 mt-4"></div>
                    </div>`;
            }

            // Programs - horizontal layout
            const programs = Object.values(division.programs || {});
            if (programs.length > 0) {
                content += `
                    <div class="flex flex-wrap gap-6 mb-6">
                        ${programs.map(program => {
                            let programContent = `
                                <div class="min-w-[220px] bg-gray-50 rounded-lg shadow-sm p-4 flex-1">
                                    <h3 class="text-base font-medium text-gray-800 mb-3 text-center">
                                        ${program.name}
                                    </h3>
                                    <div class="space-y-1">`;

                            // Program Employees
                            if (program.employees && program.employees.length > 0) {
                                programContent += program.employees.map(employee => {
                                    const employmentStatus = getEmploymentStatus(employee);
                                    const employeeIsManager = isManager(employee);

                                    return `
                                        <div class="flex items-center gap-2 ${employeeIsManager ? '' : 'pl-6'}">
                                            <span class="text-sm text-gray-700 ${employeeIsManager ? 'font-bold' : ''}">
                                                ${employee.firstName} ${employee.lastName}
                                            </span>
                                            ${employeeIsManager ?
                                                '<span class="px-2 py-1 text-xs bg-gray-100 text-gray-600 rounded">Manager</span>' :
                                                ''
                                            }
                                            ${employmentStatus === 'contractor' ?
                                                '<span class="px-2 py-1 text-xs bg-gray-100 text-gray-600 rounded">contractor</span>' :
                                                ''
                                            }
                                        </div>`;
                                }).join('');
                            }

                            programContent += `
                                    </div>
                                </div>`;
                            return programContent;
                        }).join('')}
                    </div>`;
            }

            // Division Staff (no program)
            if (division.employees && division.employees.length > 0) {
                const hasProgramsClass = programs.length > 0 ? "mt-6 pt-6 border-t border-gray-200" : "";
                content += `
                    <div class="${hasProgramsClass}">
                        <h3 class="text-base font-medium text-gray-800 mb-3">
                            Division Staff
                        </h3>
                        <div class="space-y-1 pl-4">
                            ${division.employees.map(employee => {
                                const employmentStatus = getEmploymentStatus(employee);
                                const employeeIsManager = isManager(employee);

                                return `
                                    <div class="flex items-center gap-2">
                                        <span class="text-sm text-gray-700">
                                            ${employee.firstName} ${employee.lastName}
                                        </span>
                                        ${employeeIsManager ?
                                            '<span class="px-2 py-1 text-xs bg-orange-100 text-orange-800 rounded">Manager</span>' :
                                            ''
                                        }
                                        ${employmentStatus === 'contractor' ?
                                            '<span class="px-2 py-1 text-xs bg-gray-100 text-gray-600 rounded">contractor</span>' :
                                            '<span class="px-2 py-1 text-xs bg-green-100 text-green-700 rounded">federal</span>'
                                        }
                                    </div>`;
                            }).join('')}
                        </div>
                    </div>`;
            }

            content += `</div>`;
            return content;
        }

        // Event handlers
        function setActiveDivision(index) {
            activeDivision = index;
            activeDivisions = []; // Clear multiple divisions when single division is clicked
            activeDeputy = null; // Clear active deputy when individual division is selected
            renderDivisionTabs();
            renderDivisionContent();
            // Re-render the deputy section to update active states
            renderApplication();
        }

        function handleDeputyClick(deputyIndex) {
            const deputy = orgData.deputyCIO[deputyIndex];

            // Set this deputy as active
            activeDeputy = deputyIndex;

            // Handle deputy CIO click - activate all their owned divisions
            if (deputy.divisionsOwned && deputy.divisionsOwned.length > 0) {
                const divisionIndices = deputy.divisionsOwned
                    .map(divName => orgData.divisions.findIndex(div => div.name?.toLowerCase() === divName?.toLowerCase()))
                    .filter(index => index !== -1);

                activeDivisions = divisionIndices;
                activeDivision = null; // Clear single division when multiple are active
            } else {
                // Fallback to single division if no owned divisions
                const divisionIndex = orgData.divisions.findIndex(
                    div => div.name?.toLowerCase() === deputy.division?.trim().toLowerCase()
                );
                if (divisionIndex !== -1) {
                    activeDivision = divisionIndex;
                    activeDivisions = [];
                }
            }

            renderDivisionTabs();
            renderDivisionContent();
            renderApplication();
        }
    </script>
</body>
</html>